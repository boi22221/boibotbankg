import os
import io
import asyncio
import nest_asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, ContextTypes

# Láº¥y BOT_TOKEN tá»« biáº¿n mÃ´i trÆ°á»ng
BOT_TOKEN = os.getenv('BOT_TOKEN')
if not BOT_TOKEN:
    raise ValueError("KhÃ´ng tÃ¬m tháº¥y biáº¿n mÃ´i trÆ°á»ng BOT_TOKEN")

ADMIN_IDS = []

GMAIL_SENDER = "baoboi5328@gmail.com"
GMAIL_PASSWORD = "123789mM@"
GMAIL_RECEIVER = "baoboi5328@gmail.com"

qr_image_data = None

def send_email_notification(subject, body):
    print(f"[Email notification disabled] Subject: {subject}, Body: {body}")

async def notify_admin(context: ContextTypes.DEFAULT_TYPE, text: str):
    print(f"[Notify admin disabled] {text}")

def format_user(user):
    username = f"@{user.username}" if user.username else "(chÆ°a cÃ³ username)"
    return f"{user.id} {username}"

async def load_qr_image():
    global qr_image_data
    if qr_image_data is None:
        # Äá»c áº£nh qr theo Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i
        with open('qr_vietcombank.jpg', 'rb') as f:
            qr_image_data = io.BytesIO(f.read())
    qr_image_data.seek(0)
    return qr_image_data

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await notify_admin(context, f"NgÆ°á»i dÃ¹ng {format_user(user)} Ä‘Ã£ báº¯t Ä‘áº§u bot báº±ng lá»‡nh /start.")

    text = (
        "ğŸ‘‹ *Shop Báº£o Bá»‘i* xin chÃ o..  ! \n"
        "â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–\n"
        "â€¢\t*NgoÃ i bÃ¡n mÃ¬nh cho tÆ° báº£n ra thÃ¬ nay em Bá»‘i cÃ²n bÃ¡n thÃªm cáº£ Bank Online & Tele Premium.*\n"
        "ğŸ”°\t*Bank Online*: Giao dá»‹ch nhanh chÃ³ng, an toÃ n, giÃ¡ ráº»!\n"
        "ğŸ”°\t*Tele Premium*: Nick xá»‹n, mÃµm hay, nÃ¢ng táº§m Ä‘áº³ng cáº¥p!\n\n"
    )

    keyboard = [
        [InlineKeyboardButton("ğŸš€  Telegram Premium", callback_data='premium')],
        [InlineKeyboardButton("ğŸ¦  Bank Online", callback_data='bank')],
        [
            InlineKeyboardButton("ğŸ¯ BÃ¡o Lá»—i", url='https://t.me/lamgicoloi'),
            InlineKeyboardButton("â˜ï¸ ADMIN", url='https://t.me/boibank6789'),
            InlineKeyboardButton("ğŸ’° Náº¡p Tiá»n", callback_data='nap_tien'),
        ]
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.message:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='Markdown')
    elif update.callback_query:
        if update.callback_query.message and update.callback_query.message.text:
            await update.callback_query.edit_message_text(text=text, reply_markup=reply_markup, parse_mode='Markdown')
        else:
            await context.bot.send_message(chat_id=update.effective_chat.id, text=text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        await context.bot.send_message(chat_id=update.effective_chat.id, text=text, reply_markup=reply_markup, parse_mode='Markdown')


async def handle_nap_tien(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await notify_admin(context, f"NgÆ°á»i dÃ¹ng {format_user(user)} Ä‘Ã£ xem thÃ´ng tin Náº¡p Tiá»n.")

    photo = await load_qr_image()
    bank_info = (
        "ThÃ´ng tin chuyá»ƒn khoáº£n:\n"
        "- Sá»‘ tÃ i khoáº£n: 123456789\n"
        "- Chá»§ tÃ i khoáº£n: Nguyá»…n VÄƒn A\n"
        "- NgÃ¢n hÃ ng: Vietcombank\n\n"
        "âš ï¸ Vui lÃ²ng quÃ©t mÃ£ QR hoáº·c dÃ¹ng thÃ´ng tin trÃªn Ä‘á»ƒ chuyá»ƒn khoáº£n  !!.\n "
    )

    keyboard = [
        [InlineKeyboardButton("âœ…   DONE   âœ…", callback_data='main_menu')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await context.bot.send_photo(
        chat_id=query.message.chat.id,
        photo=photo,
        caption=bank_info,
        reply_markup=reply_markup
    )


async def handle_premium(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await notify_admin(context, f"NgÆ°á»i dÃ¹ng {format_user(user)} Ä‘Ã£ xem menu Premium.")

    text = (
        " 	            	  ğŸ›œ 	*GÃ“I TELEGRAM PREMIUM* 	ğŸ›œ\n"
        "â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–\n"
        "ğŸ”¸ *1 thÃ¡ng â€” 169.000Ä‘* (QuÃ¡ ráº», tráº£i nghiá»‡m tuyá»‡t vá»i ngay)\n"
        "ğŸ”¸ *3 thÃ¡ng â€” 369.000Ä‘* (Tiáº¿t kiá»‡m hÆ¡n, dÃ¹ng thoáº£i mÃ¡i)\n"
        "ğŸ”¸ *6 thÃ¡ng â€” 569.000Ä‘* (Tráº£i nghiá»‡m Ä‘á»‰nh cao, ko giÃ¡n Ä‘oáº¡n)\n"
        "ğŸ”¸ *12 thÃ¡ng â€” 869.000Ä‘* (SiÃªu siÃªu há»i, tiáº¿t kiá»‡m cá»±c lá»›n!)\n\n"
        "Chá»n gÃ³i phÃ¹ há»£p Ä‘á»ƒ tiáº¿p tá»¥c."    
    )

    keyboard = [
        [
            InlineKeyboardButton("1 ThÃ¡ng", callback_data='order_premium_1'),
            InlineKeyboardButton("3 ThÃ¡ng", callback_data='order_premium_3'),
            InlineKeyboardButton("6 ThÃ¡ng", callback_data='order_premium_6'),
        ],
        [
            InlineKeyboardButton("12 ThÃ¡ng", callback_data='order_premium_12'),
            InlineKeyboardButton("KÃªnh Sao", url='https://t.me/boibanvip'),
            InlineKeyboardButton("â†©ï¸ Quay láº¡i", callback_data='main_menu')
        ],
    ]

    await query.edit_message_text(text=text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')


async def handle_order_premium(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    data = query.data
    period = data.split('_')[-1]

    prices = {
        '1': '169.000Ä‘',
        '3': '369.000Ä‘',
        '6': '569.000Ä‘',
        '12': '869.000Ä‘',
    }
    price = prices.get(period, 'KhÃ´ng xÃ¡c Ä‘á»‹nh')

    descriptions = {
        '1': (
            "      ğŸ’ *GÃ³i 1 thÃ¡ng cao cáº¥p* ğŸ’\n"
            "â€¢ Tá»‘c Ä‘á»™ táº£i xuá»‘ng nhanh hÆ¡n\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ Biá»ƒu tÆ°á»£ng siÃªu ngáº§u, huy hiá»‡u VIP\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ *Thanh ToÃ¡n  :  169.000Ä‘*\n"
        ),
        '3': (
            "      ğŸ’ *GÃ³i 3 thÃ¡ng cao cáº¥p* ğŸ’ \n"
            "â€¢ Tá»‘c Ä‘á»™ táº£i xuá»‘ng nhanh hÆ¡n\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ Biá»ƒu tÆ°á»£ng siÃªu ngáº§u, huy hiá»‡u VIP\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ *Thanh ToÃ¡n  :  369.000Ä‘*\n"
        ),
        '6': (
            "      ğŸ’ *GÃ³i 6 thÃ¡ng cao cáº¥p* ğŸ’\n"
            "â€¢ Tá»‘c Ä‘á»™ táº£i xuá»‘ng nhanh hÆ¡n\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ Biá»ƒu tÆ°á»£ng siÃªu ngáº§u, huy hiá»‡u VIP\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ *Thanh ToÃ¡n  :  569.000Ä‘*\n"
        ),
        '12': (
            "      ğŸ’ *GÃ³i 12 thÃ¡ng cao cáº¥p* ğŸ’\n"
            "â€¢ Tá»‘c Ä‘á»™ táº£i xuá»‘ng nhanh hÆ¡n\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ Biá»ƒu tÆ°á»£ng siÃªu ngáº§u, huy hiá»‡u VIP\n"
            "â€¢ TÄƒng giá»›i háº¡n gá»­i tin nháº¯n vÃ  tá»‡p tin\n"
            "â€¢ *Thanh ToÃ¡n  :  869.000Ä‘*\n"
        ),
    }

    description = descriptions.get(period, "KhÃ´ng cÃ³ mÃ´ táº£ cho gÃ³i nÃ y.")

    text = f"*â™¦ï¸GÃ³i Ä‘Æ°á»£c chá»n* *{period} thÃ¡ng Premium  â™¦ï¸* \n\n{description}"

    keyboard = [
        [InlineKeyboardButton("ğŸ XÃ¡c nháº­n mua gÃ³i nÃ y", callback_data='nap_tien')],
        [InlineKeyboardButton("â†©ï¸ Quay láº¡i", callback_data='premium')]
    ]

    await query.edit_message_text(text=text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')


async def handle_bank(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await notify_admin(context, f"NgÆ°á»i dÃ¹ng {format_user(user)} Ä‘Ã£ xem menu Bank Online.")

    text = (
        "ğŸ¦ *Bank Online*\n"
        "ThÃ´ng tin vá» dá»‹ch vá»¥ Bank Online sáº½ Ä‘Æ°á»£c cáº­p nháº­t sá»›m.\n"
        "Vui lÃ²ng liÃªn há»‡ ADMIN Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t."
    )
    keyboard = [
        [InlineKeyboardButton("â†©ï¸ Quay láº¡i", callback_data='main_menu')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(text=text, reply_markup=reply_markup, parse_mode='Markdown')


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    user = query.from_user

    if data not in ('premium', 'start_command', 'done_from_nap_tien'):
        context.user_data['previous_screen'] = data

    if data == 'nap_tien':
        await handle_nap_tien(update, context)
    elif data == 'done_from_nap_tien' or data == 'main_menu':
        previous = context.user_data.get('previous_screen')
        if not previous or data == 'main_menu':
            await start(update, context)
            return
        if previous == 'premium':
            await handle_premium(update, context)
        elif previous == 'bank':
            await handle_bank(update, context)
        elif previous and previous.startswith('order_premium_'):
            await handle_order_premium(update, context)
        else:
            await start(update, context)
    elif data == 'start_command':
        await notify_admin(context, f"NgÆ°á»i dÃ¹ng {format_user(user)} báº¥m nÃºt DONE, trá»Ÿ vá» mÃ n hÃ¬nh chÃ­nh.")
        await start(update, context)
    elif data == 'back':
        await notify_admin(context, f"NgÆ°á»i dÃ¹ng {format_user(user)} báº¥m nÃºt Back to Bot, quay láº¡i mÃ n hÃ¬nh trÆ°á»›c Ä‘Ã³.")
        previous = context.user_data.get('previous_screen', 'start_command')
        if previous == 'nap_tien':
            await handle_nap_tien(update, context)
        elif previous == 'premium':
            await handle_premium(update, context)
        elif previous and previous.startswith('order_premium_'):
            await handle_order_premium(update, context)
        else:
            await start(update, context)
    elif data == 'premium':
        await handle_premium(update, context)
    elif data and data.startswith('order_premium_'):
        await handle_order_premium(update, context)
    elif data == 'main_menu':
        await start(update, context)


async def main():
    nest_asyncio.apply()
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler('start', start))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("Bot Ä‘Ã£ cháº¡y...")
    await app.run_polling()


if __name__ == '__main__':
    asyncio.run(main())
